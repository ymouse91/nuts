<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Squirrels Go Nuts! ‚Äì testipulmat</title>
		  		<!-- iOS PWA -liput -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2a2a2a">
  <link rel="apple-touch-icon" sizes="182x182" href="./icon182.png">

  <style>
    *{ box-sizing:border-box; margin:0; padding:0; }
html, body{ overscroll-behavior: none; }
    html, body { height:100%; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f2f2f2;
      padding: calc(env(safe-area-inset-top) + 12px) 12px calc(env(safe-area-inset-bottom) + 16px);
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .app{
      width:min(560px, 96vw);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    h1{
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      text-align:center;
      margin-top:4px;
    }

    .panel{
      width:100%;
      background:#fff;
      border-radius:14px;
      padding:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .toprow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .status{
      font-weight:700;
      padding:8px 10px;
      border-radius:12px;
      background:#f5f5f5;
      flex: 1 1 auto;
      min-width: 240px;
    }
    .status.success{ background:#e9ffe9; }

    .btn{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      background:#2a2a2a;
      color:#fff;
      white-space:nowrap;
    }

    .select{
      border:2px solid #ddd;
      border-radius:12px;
      padding:9px 10px;
      font-weight:800;
      background:#fff;
    }

    .boardWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:10px 0;
    }

    .board{
      width:min(380px, 86vw);
      aspect-ratio: 1 / 1;
      background:#5b3c1d;
      border-radius:16px;
      padding:10px;
      box-shadow: inset 0 0 0 3px rgba(255,255,255,.12);
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      grid-template-rows:repeat(4, 1fr);
      gap:6px;
      position:relative;
      touch-action: none;
    }

    .cell{
      background:#3a2816;
      border-radius:12px;
      position:relative;
      overflow:hidden;
    }
/* Ruudun numero (0‚Äì15) oikeassa alakulmassa */
.cellNum{
  position:absolute;
  right:6px;
  bottom:4px;
  font-size:11px;
  font-weight:800;
  color: rgba(255,255,255,.55);
  z-index: 0;           /* j√§√§ rei√§n ja palojen alle */
  pointer-events:none;
  text-shadow: 0 1px 2px rgba(0,0,0,.45);
}

    /* Reik√§: tyhj√§ vaalea, t√§ysi tumma */
    .hole{
      position:absolute;
      inset:22%;
      border-radius:999px;
      z-index: 1;
      background: radial-gradient(circle at 35% 35%, #fff 0%, #e8e8e8 55%, #d8d8d8 100%);
      box-shadow: inset 0 2px 8px rgba(0,0,0,.18);
      opacity: .98;
    }
    .hole.filled{
      background: radial-gradient(circle at 35% 35%, #222 0%, #000 55%, #111 100%);
      box-shadow: inset 0 2px 8px rgba(255,255,255,.08);
      opacity: 1;
    }

    /* Palan t√§ytt√∂ */
    .pieceFill{
      position:absolute;
      inset:6%;
      border-radius:10px;
      z-index: 3;
      cursor:pointer;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.30);
      transform: translateZ(0);
    
  pointer-events: none;
}

    /* valittu pala: kevyt hohto joka ruudussa */
    .selGlow{
      position:absolute;
      inset:2%;
      border-radius:12px;
      outline: 6px solid rgba(255,215,0,.95);
      outline-offset: -1px;
      z-index: 2;
      pointer-events:none;
    }

.pYellow {
  background: #cfe58a;   /* vihert√§v√§ keltainen */
}
.pOrange {
  background: #f2a14b;   /* selke√§ oranssi */
}
.pGrey {
  background: #c9cec6;   /* vaalea harmaa */
}


    /* Aliases for builder.json colors */
    .pGreyA { background: #c9ced6; }   /* same as .pGrey */
    .pGreyB { background: #9f96b2; }   /* same as .pGreyDark */
    .pOrange { background: #f2a14b; }
    .pYellow { background: #cfe58a; }
	
.pGreyDark {
  background: #9f96b2;   /* tummempi harmaa */
}

    /* Estepala (vain pulma 13): kukka */
    .flower{
      position:absolute;
      inset:6%;
      border-radius:10px;
      z-index: 6;
      background:#a7f0a7;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
      border: 3px solid rgba(0,0,0,.62);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:40px;
      pointer-events:none;
    }

    /* P√§hkin√§ palan sis√§ll√§ */
    .nut{
      position:absolute;
      inset:18%;
      border-radius:10px;
      z-index: 7;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      pointer-events:none;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.35));
    }
    .hint{
      font-size:13px;
      opacity:.85;
      line-height:1.25;
      text-align:center;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>

<body>
<div class="app">
  <h1 id="title">P√§hkin√§ purtavaksi</h1>

  <div class="panel">
    <div class="toprow">
      <select id="puzzleSelect" class="select" aria-label="Pulmavalinta"></select>
      <div id="status" class="status">Siirr√§ p√§hkin√§t piiloon.</div>
      <button id="resetBtn" class="btn">Alkuun</button>
    </div>

    <div class="boardWrap">
      <div id="board" class="board" aria-label="Pelilauta 4x4"></div>
    </div>

<div class="hint">
      Kolot ovat ruuduissa <code>[2,4,9,15]</code>.<br>
      P√§hkin√§ putoaa, kun se osuu tyhj√§√§n koloon.
    </div>
  </div>
</div>

<script>
(() => {
  // PWA
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    });
  }

  const boardEl = document.getElementById("board");
  const statusEl = document.getElementById("status");
  const resetBtn = document.getElementById("resetBtn");
  const selEl = document.getElementById("puzzleSelect");

  const W=4, H=4;
  const HOLES = new Set([2,4,9,15]);
  function idx(r,c){ return r*W+c; }
  function inBounds(r,c){ return r>=0 && r<H && c>=0 && c<W; }

  // --- Pulmat (13 ja 37) ---
  // Note: puzzle pieces given as absolute cells + nut_cell (absolute).
  let PUZZLES_RAW = [
    {
      id: 13,
      name: "Pulma 13",
      obstacles: [{ type:"flower", cell:[0,2] }], // t√§m√§ on oikea estepala
      pieces: [
        { id:"P_grey",   color:"pGrey",   cells:[[2,2],[3,2]],            nut_cell:[2,2] },
        { id:"P_orange", color:"pOrange", cells:[[3,0],[3,1],[2,1]],      nut_cell:[3,1] }
      ]
    },
    {
      id: 37,
      name: "Pulma 37",
      obstacles: [],
      pieces: [
        { id:"S_grey",     color:"pGrey",   cells:[[0,1],[1,1]],          nut_cell:[0,1] },
        { id:"S_yellow_L", color:"pYellow", cells:[[0,3],[1,2],[1,3]],    nut_cell:[1,3] },
        { id:"S_orange",   color:"pOrange", cells:[[2,2],[3,2]],          nut_cell:[3,2] },
        { id:"S_grey_L",   color:"pGreyDark",   cells:[[2,1],[3,0],[3,1]],    nut_cell:[3,0] }
      ]
    }
  ];

  // --- Lataa pulmat ulkoisesta JSON-kirjastosta (builderin output) ---
  // Odotettu muoto: { version, holes_fixed, puzzles:[{id,name,pieces:[{id,shape,rot,cells,nut_cell,color}]}] }
  function convertLibraryToRaw(lib){
    if(!lib || !Array.isArray(lib.puzzles)) return null;
    const out = [];
    for(const pz of lib.puzzles){
      if(!pz) continue;
      const pieces = Array.isArray(pz.pieces) ? pz.pieces : [];
      out.push({
        id: Number(pz.id),
        name: String(pz.name || `Pulma ${pz.id}`),
        obstacles: [], // builderiss√§ kukka on normaali pala (X1)
        pieces: pieces.map(pp => ({
          id: String(pp.id),
          color: (String(pp.id)==="Flower") ? null : (pp.color || "pGrey"),
          cells: pp.cells,
          nut_cell: pp.nut_cell || null
        }))
      });
    }
    // suodata pois virheelliset
    return out.filter(p => Number.isFinite(p.id) && Array.isArray(p.pieces));
  }

  async function tryLoadPuzzlesJson(){
    // 1) yrit√§ hakea oletus: ./puzzles.json
    try{
      const res = await fetch("./puzzles.json?v="+Date.now(), {cache:"no-store"});
      if(!res.ok) return false;
      const lib = await res.json();
      const converted = convertLibraryToRaw(lib);
      if(!converted || converted.length===0) return false;
      PUZZLES_RAW = converted;
      return true;
    }catch(e){
      return false;
    }
  }

  // --- state ---
  let currentPuzzleId = 13;
  let state = null;
  let selectedId = null;
  let moves = 0;
  let solved = false;

  function setStatus(text, kind){
    statusEl.textContent = text;
    statusEl.classList.remove("success");
    if(kind) statusEl.classList.add(kind);
  }

  // Muunna RAW-palan (abs solut) sis√§iseksi muodoksi: anchor + offsets + nut_local
  function normalizePiece(rawPiece){
    const [ar, ac] = rawPiece.cells[0]; // ankkuri: ensimm√§inen solu
    const offsets = rawPiece.cells.map(([r,c]) => ({ dr:r-ar, dc:c-ac }));
    const nut_local = rawPiece.nut_cell ? { dr: rawPiece.nut_cell[0]-ar, dc: rawPiece.nut_cell[1]-ac } : null;
    return {
      id: rawPiece.id,
      color: rawPiece.color,
      anchor: { r: ar, c: ac },
      offsets,
      hasNut: !!rawPiece.nut_cell,
      nut_local
    };
  }

  function absCells(p){
    return p.offsets.map(o => ({ r: p.anchor.r + o.dr, c: p.anchor.c + o.dc }));
  }

  function nutAbs(p){
    if(!p.hasNut || !p.nut_local) return null;
    return { r: p.anchor.r + p.nut_local.dr, c: p.anchor.c + p.nut_local.dc };
  }

  function isObstacleAt(r,c){
    return state.obstacles.some(o => o.cell[0]===r && o.cell[1]===c);
  }

  function buildOccupied(excludeId=null){
    const occ = new Map();
    for(const o of state.obstacles){
      occ.set(`${o.cell[0]},${o.cell[1]}`, {type:"obstacle"});
    }
    for(const p of state.pieces){
      if(p.id===excludeId) continue;
      for(const cc of absCells(p)){
        occ.set(`${cc.r},${cc.c}`, {type:"piece", id:p.id});
      }
    }
    return occ;
  }

  function getPiece(id){
    return state.pieces.find(p=>p.id===id) || null;
  }

  function anyNutLeft(){
    return state.pieces.some(p => p.hasNut);
  }

  function tryDropNut(p){
    if(!p.hasNut) return;
    const n = nutAbs(p);
    if(!n) return;
    const h = idx(n.r, n.c);
    if(!HOLES.has(h)) return;
    if(state.filledHoles.has(h)) return;
    if(isObstacleAt(n.r,n.c)) return; // estepala peitt√§√§ rei√§n (pulma 13)
    state.filledHoles.add(h);
    p.hasNut = false;
  }

  function canStep(id, dr, dc){
    if(solved) return false;
    const p = getPiece(id);
    if(!p) return false;

    const occ = buildOccupied(p.id);

    for(const o of p.offsets){
      const rr = p.anchor.r + dr + o.dr;
      const cc = p.anchor.c + dc + o.dc;
      if(!inBounds(rr,cc)) return false;
      if(occ.has(`${rr},${cc}`)) return false;
    }
    return true;
  }

  function step(dr, dc){
    if(!selectedId || solved) return;
    const p = getPiece(selectedId);
    if(!p) return;
    if(!canStep(p.id, dr, dc)) return;

    p.anchor.r += dr;
    p.anchor.c += dc;

    tryDropNut(p);

    moves++;
    if(!anyNutLeft()){
      solved = true;
      setStatus(`üéâ Ratkaistu! Siirtoja: ${moves}`, "success");
    } else {
      setStatus(`Siirtoja: ${moves}`, "");
    }
    render();
  }

  function loadPuzzle(puzzleId){
    const raw = PUZZLES_RAW.find(p => p.id===puzzleId);
    if(!raw) return;

    currentPuzzleId = puzzleId;
    moves = 0;
    solved = false;

    state = {
      id: raw.id,
      name: raw.name,
      obstacles: raw.obstacles.map(o => ({ type:o.type, cell:[o.cell[0],o.cell[1]] })),
      pieces: raw.pieces.map(normalizePiece),
      filledHoles: new Set()
    };

    selectedId = state.pieces[0]?.id || null;
    setStatus("Siirr√§ p√§hkin√§t piiloon.", "");
    render();
  }

  function reset(){
    loadPuzzle(currentPuzzleId);
  }

  function pieceAt(r,c){
    for(const p of state.pieces){
      for(const cc of absCells(p)){
        if(cc.r===r && cc.c===c) return p.id;
      }
    }
    return null;
  }

  function render(){
    boardEl.innerHTML = "";

    // ruudut + rei√§t
    for(let r=0;r<H;r++){
      for(let c=0;c<W;c++){
        const cell = document.createElement("div");
        cell.className = "cell";

// ruudun numero oikeaan alakulmaan
const num = document.createElement("div");
num.className = "cellNum";
num.textContent = String(idx(r,c)); // 0..15
cell.appendChild(num);

        const h = idx(r,c);
        if(HOLES.has(h)){
          const hole = document.createElement("div");
          hole.className = "hole" + (state.filledHoles.has(h) ? " filled" : "");
          cell.appendChild(hole);
        }

        cell.addEventListener("pointerdown", (e)=>{
          e.preventDefault();
          if(solved) return;
          const pid = pieceAt(r,c);
		  if(pid === "Flower") return;
          if(pid){
            selectedId = pid;
            render();
          }
        });

        boardEl.appendChild(cell);
      }
    }

    // valinta-hohto
    if(selectedId){
      const p = getPiece(selectedId);
      if(p){
        for(const cc of absCells(p)){
          const cell = boardEl.children[idx(cc.r,cc.c)];
          const g = document.createElement("div");
          g.className = "selGlow";
          cell.appendChild(g);
        }
      }
    }

    // palojen t√§yt√∂t
    for(const p of state.pieces){
      for(const cc of absCells(p)){
        const cell = boardEl.children[idx(cc.r,cc.c)];

        // Flower on 1√ó1 estepala: n√§ytet√§√§n kukkana, ei harmaana palana
        if(p.id==="Flower" || p.color===null){
          const el = document.createElement("div");
          el.className = "flower";
          el.textContent = "ü™®";
          cell.appendChild(el);
          continue;
        }

        const fill = document.createElement("div");
        fill.className = `pieceFill ${p.color}`;
        cell.appendChild(fill);
      }
    }

    // estepalat (vain pulma 13: kukka)
    for(const o of state.obstacles){
      if(o.type==="flower"){
        const r=o.cell[0], c=o.cell[1];
        const cell = boardEl.children[idx(r,c)];
        const el = document.createElement("div");
        el.className = "flower";
        el.textContent = "ü™®";
        cell.appendChild(el);
      }
    }

    // p√§hkin√§t
    for(const p of state.pieces){
      if(!p.hasNut) continue;
      const n = nutAbs(p);
      if(!n) continue;
      const cell = boardEl.children[idx(n.r,n.c)];
      const nt = document.createElement("div");
      nt.className = "nut";
      nt.textContent = "üå∞";
      cell.appendChild(nt);
    }
  }

  // UI wire-up
  function initSelector(){
    selEl.innerHTML = "";
    for(const p of PUZZLES_RAW){
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = p.name;
      selEl.appendChild(opt);
    }
    selEl.value = String(currentPuzzleId);
    selEl.addEventListener("change", ()=>{
      loadPuzzle(Number(selEl.value));
    });
  }

  // controls
  resetBtn.addEventListener("click", reset);

  // keys (PC)
  window.addEventListener("keydown", (e)=>{
    if(!selectedId || solved) return;
    if(e.key==="ArrowUp")    { e.preventDefault(); step(-1,0); }
    if(e.key==="ArrowDown")  { e.preventDefault(); step(1,0); }
    if(e.key==="ArrowLeft")  { e.preventDefault(); step(0,-1); }
    if(e.key==="ArrowRight") { e.preventDefault(); step(0,1); }
  });


// drag (hiiri + iPad/iPhone): 1 askel kerrallaan, kun veto ylitt√§√§ kynnyksen
const DRAG_THRESHOLD = 26; // px
let drag = { active:false, pid:null, x:0, y:0, pointerId:null };

function beginDrag(e, pid){
  if(solved) return;
  drag.active = true;
  drag.pid = pid;
  drag.x = e.clientX;
  drag.y = e.clientY;
  drag.pointerId = e.pointerId;
  try{ boardEl.setPointerCapture(e.pointerId); }catch(_){}
}

function endDrag(){
  drag.active = false;
  drag.pid = null;
  drag.pointerId = null;
}

// iOS Safari: est√§ sivun vieritys / "rubber band" kun vedet√§√§n paloja
// (passive:false on pakollinen jotta preventDefault toimii)
document.addEventListener("touchmove", (ev)=>{
  if(drag.active) ev.preventDefault();
}, {passive:false});

function dragMove(e){
  if(!drag.active) return;
  if(solved) return;

  if(drag.pid && selectedId !== drag.pid){
    selectedId = drag.pid;
    render();
  }

  const dx = e.clientX - drag.x;
  const dy = e.clientY - drag.y;
  const ax = Math.abs(dx), ay = Math.abs(dy);

  if(Math.max(ax, ay) < DRAG_THRESHOLD) return;

  // P√§√§t√§ suunta (dominoiva akseli)
  if(ax > ay){
    step(0, dx > 0 ? 1 : -1);
  }else{
    step(dy > 0 ? 1 : -1, 0);
  }

  // Resetoi l√§ht√∂piste jotta voi jatkaa vet√§mist√§ useamman askeleen
  drag.x = e.clientX;
  drag.y = e.clientY;
}

// Aloitus: painallus palan p√§√§lt√§ (tai sen ruudusta)
boardEl.addEventListener("pointerdown", (e)=>{
  if(solved) return;

  const rect = boardEl.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  if(x<0 || y<0 || x>rect.width || y>rect.height) return;

  const cellW = rect.width / W;
  const cellH = rect.height / H;
  const c = Math.min(W-1, Math.max(0, Math.floor(x / cellW)));
  const r = Math.min(H-1, Math.max(0, Math.floor(y / cellH)));

  const pid = pieceAt(r,c);
  if(pid === "Flower") return;
  if(pid){
    selectedId = pid;
    render();
    e.preventDefault();
    beginDrag(e, pid);
  }
});

boardEl.addEventListener("pointermove", (e)=>{
  if(!drag.active) return;
  e.preventDefault();
  dragMove(e);
});

boardEl.addEventListener("pointerup", (e)=>{
  if(!drag.active) return;
  e.preventDefault();
  endDrag();
});

boardEl.addEventListener("pointercancel", ()=> endDrag());

// start
  (async()=>{
    const ok = await tryLoadPuzzlesJson();
    // jos ladattiin uusi kirjasto, valitaan ensimm√§inen pulma
    if(ok && PUZZLES_RAW.length>0){
      currentPuzzleId = PUZZLES_RAW[0].id;
    }
    initSelector();
    loadPuzzle(currentPuzzleId);
  })();
})();
</script>
<!-- QR Koodi yms‚Ä¶ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
  #qrOverlay{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);z-index:999;
  }
  #qrBox{
    background:#fff;padding:16px 20px;border-radius:12px;text-align:center;
    box-shadow:0 0 20px rgba(0,0,0,.4);
  }
  #qrBox canvas{width:180px;height:180px;}
</style>

<div id="qrOverlay">
  <div id="qrBox">
    <canvas id="qr"></canvas>
    <p>ymouse91.github.io/nuts/</p>
  </div>
</div>

<script>
const qr=new QRious({
  element:document.getElementById('qr'),
  value:'https://ymouse91.github.io/nuts/',
  size:180
});
const overlay=document.getElementById('qrOverlay');
document.getElementById('title').onclick=()=>overlay.style.display='flex';
overlay.onclick=()=>overlay.style.display='none';
</script>
</body>
</html>
